<?xml version="1.0"?>
<bindings id="custombuttons-toolbar-bindings"
          xmlns="http://www.mozilla.org/xbl"
          xmlns:xbl="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">

	<binding id="custombuttons-toolbar-binding"
			 extends="chrome://global/content/bindings/toolbar.xml#toolbar">
		<implementation>
			<constructor>
				<![CDATA[
					/* проверка, загрузился ли оверлей из профиля, если нет -
					   читаем его вручную и добавляем кнопки через DOM */
					if
					( // begin condition
						(this. ownerDocument. getElementsByTagName ("toolbarpalette"). length != 0) &&
						(window. custombuttons. buttonsLoadedFromProfileOverlay == false)
					) // end condition
						(
							function ()
							{ // begin function
								try
								{
									dump ('\n loading buttons "by hands"');
									var palette = this. ownerDocument. getElementsByTagName ("toolbarpalette") [0];
									var file = Components. classes ["@mozilla.org/file/directory_service;1"].
											   getService (Components. interfaces. nsIProperties).
											   get ("ProfD", Components. interfaces. nsIFile); // get profile folder
									file. append ("custombuttons");   // extensions sub-directory
									file. append ("buttonsoverlay.xul");
									var req = new XMLHttpRequest ();
									req. open ("GET", "file://" + file. path, false); 
									req. send (null);
									var dom = req. responseXML;
									if (!(dom. documentElement. nodeName == "parsererror"))
									{
										var overlayPalette = dom. getElementById ('BrowserToolbarPalette');
										for (var i = 0; i < overlayPalette. childNodes. length; i++)
										{
											if (overlayPalette. childNodes [i]. nodeType == 1)
											{
												dump ('\ni=' + i);
												palette. appendChild (overlayPalette. childNodes [i]. cloneNode (true));
											}
										}
									}
									dom = null;
								}
								catch (e) {}
							} // end function
						). apply (this);
                ]]>
            </constructor>
        </implementation>
    </binding>

</bindings>
